import java.io.IOException;
import java.net.DatagramPacket;
import java.net.DatagramSocket;
import java.net.InetAddress;
import java.net.SocketException;
import java.util.HashMap;
import java.util.Map;
import java.util.Timer;

public class Connector implements Runnable {
	
	private Map<InetAddress, Long> connectedUsers;
	private int port;
	private DatagramSocket listenerSocket = null;
	private Updater updater;
	
	private final int updatePeriod = 100;
	
	public Map<InetAddress, Long> getConnectedUsers() {
		return connectedUsers;
	}

	public Connector(int port) throws SocketException {
		connectedUsers = new HashMap<InetAddress, Long>();
		updater = new Updater(connectedUsers, updatePeriod);
		this.port = port;
		listenerSocket = new DatagramSocket(port);
	}
	
	@Override
	public void run() {
		(new Timer()).schedule(updater, 0, updatePeriod);
		byte[] receiveData = new byte[1];
		while(true) {
			System.out.println("Listening for new connections");
			DatagramPacket receivePacket = new DatagramPacket(receiveData, receiveData.length);
			try {
				listenerSocket.receive(receivePacket);
			} catch (IOException e) {
				e.printStackTrace();
			}
			System.out.println(receivePacket.getAddress() + " connected");
			connectedUsers.put(receivePacket.getAddress(), System.currentTimeMillis());
		}
	}

}
